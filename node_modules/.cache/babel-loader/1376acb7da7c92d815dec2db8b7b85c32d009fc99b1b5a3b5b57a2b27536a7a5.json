{"ast":null,"code":"// Copyright (c) 2018-2023 Coinbase, Inc. <https://www.coinbase.com/>\nexport var ConnectionState;\n(function (ConnectionState) {\n  ConnectionState[ConnectionState[\"DISCONNECTED\"] = 0] = \"DISCONNECTED\";\n  ConnectionState[ConnectionState[\"CONNECTING\"] = 1] = \"CONNECTING\";\n  ConnectionState[ConnectionState[\"CONNECTED\"] = 2] = \"CONNECTED\";\n})(ConnectionState || (ConnectionState = {}));\nexport class WalletLinkWebSocket {\n  setConnectionStateListener(listener) {\n    this.connectionStateListener = listener;\n  }\n  setIncomingDataListener(listener) {\n    this.incomingDataListener = listener;\n  }\n  /**\n   * Constructor\n   * @param url WebSocket server URL\n   * @param [WebSocketClass] Custom WebSocket implementation\n   */\n  constructor(url, WebSocketClass = WebSocket) {\n    this.WebSocketClass = WebSocketClass;\n    this.webSocket = null;\n    this.isDisconnecting = false;\n    this.url = url.replace(/^http/, 'ws');\n    this.instanceId = WalletLinkWebSocket.instanceCounter++;\n    WalletLinkWebSocket.activeInstances.add(this.instanceId);\n  }\n  /**\n   * Make a websocket connection\n   * @returns a Promise that resolves when connected\n   */\n  async connect() {\n    if (this.webSocket) {\n      throw new Error('webSocket object is not null');\n    }\n    if (this.isDisconnecting) {\n      throw new Error('WebSocket is disconnecting, cannot reconnect on same instance');\n    }\n    return new Promise((resolve, reject) => {\n      var _a;\n      let webSocket;\n      try {\n        this.webSocket = webSocket = new this.WebSocketClass(this.url);\n      } catch (err) {\n        reject(err);\n        return;\n      }\n      (_a = this.connectionStateListener) === null || _a === void 0 ? void 0 : _a.call(this, ConnectionState.CONNECTING);\n      webSocket.onclose = evt => {\n        var _a;\n        this.clearWebSocket();\n        // Only reject the connection promise if we haven't connected yet\n        if (webSocket.readyState !== WebSocket.OPEN) {\n          reject(new Error(`websocket error ${evt.code}: ${evt.reason}`));\n        }\n        (_a = this.connectionStateListener) === null || _a === void 0 ? void 0 : _a.call(this, ConnectionState.DISCONNECTED);\n      };\n      webSocket.onopen = _ => {\n        var _a;\n        resolve();\n        (_a = this.connectionStateListener) === null || _a === void 0 ? void 0 : _a.call(this, ConnectionState.CONNECTED);\n        if (WalletLinkWebSocket.pendingData.length > 0) {\n          const pending = [...WalletLinkWebSocket.pendingData];\n          pending.forEach(data => this.sendData(data));\n          WalletLinkWebSocket.pendingData = [];\n        }\n      };\n      webSocket.onmessage = evt => {\n        var _a, _b;\n        if (evt.data === 'h') {\n          (_a = this.incomingDataListener) === null || _a === void 0 ? void 0 : _a.call(this, {\n            type: 'Heartbeat'\n          });\n        } else {\n          try {\n            const message = JSON.parse(evt.data);\n            (_b = this.incomingDataListener) === null || _b === void 0 ? void 0 : _b.call(this, message);\n          } catch (_c) {}\n        }\n      };\n    });\n  }\n  /**\n   * Disconnect from server\n   */\n  disconnect() {\n    var _a;\n    const {\n      webSocket\n    } = this;\n    if (!webSocket) {\n      return;\n    }\n    // Mark as disconnecting to prevent reconnection attempts on this instance\n    this.isDisconnecting = true;\n    this.clearWebSocket();\n    // Clear listeners\n    (_a = this.connectionStateListener) === null || _a === void 0 ? void 0 : _a.call(this, ConnectionState.DISCONNECTED);\n    this.connectionStateListener = undefined;\n    this.incomingDataListener = undefined;\n    try {\n      webSocket.close();\n    } catch (_b) {\n      // noop\n    }\n  }\n  /**\n   * Send data to server\n   * @param data text to send\n   */\n  sendData(data) {\n    const {\n      webSocket\n    } = this;\n    if (!webSocket) {\n      WalletLinkWebSocket.pendingData.push(data);\n      if (!this.isDisconnecting) {\n        this.connect();\n      }\n      return;\n    }\n    // Check if WebSocket is actually open before sending\n    if (webSocket.readyState !== WebSocket.OPEN) {\n      WalletLinkWebSocket.pendingData.push(data);\n      return;\n    }\n    webSocket.send(data);\n  }\n  clearWebSocket() {\n    const {\n      webSocket\n    } = this;\n    if (!webSocket) {\n      return;\n    }\n    this.webSocket = null;\n    webSocket.onclose = null;\n    webSocket.onerror = null;\n    webSocket.onmessage = null;\n    webSocket.onopen = null;\n  }\n  /**\n   * remove ws from active instances\n   */\n  cleanup() {\n    WalletLinkWebSocket.activeInstances.delete(this.instanceId);\n  }\n}\n// used to differentiate instances\nWalletLinkWebSocket.instanceCounter = 0;\nWalletLinkWebSocket.activeInstances = new Set();\nWalletLinkWebSocket.pendingData = [];","map":{"version":3,"names":["ConnectionState","WalletLinkWebSocket","setConnectionStateListener","listener","connectionStateListener","setIncomingDataListener","incomingDataListener","constructor","url","WebSocketClass","WebSocket","webSocket","isDisconnecting","replace","instanceId","instanceCounter","activeInstances","add","connect","Error","Promise","resolve","reject","err","_a","call","CONNECTING","onclose","evt","clearWebSocket","readyState","OPEN","code","reason","DISCONNECTED","onopen","_","CONNECTED","pendingData","length","pending","forEach","data","sendData","onmessage","type","message","JSON","parse","_b","_c","disconnect","undefined","close","push","send","onerror","cleanup","delete","Set"],"sources":["../../../../../src/sign/walletlink/relay/connection/WalletLinkWebSocket.ts"],"sourcesContent":[null],"mappings":"AAAA;AAIA,WAAYA,eAIX;AAJD,WAAYA,eAAe;EACzBA,eAAA,CAAAA,eAAA,sCAAY;EACZA,eAAA,CAAAA,eAAA,kCAAU;EACVA,eAAA,CAAAA,eAAA,gCAAS;AACX,CAAC,EAJWA,eAAe,KAAfA,eAAe;AAM3B,OAAM,MAAOC,mBAAmB;EAY9BC,0BAA0BA,CAACC,QAAsC;IAC/D,IAAI,CAACC,uBAAuB,GAAGD,QAAQ;EACzC;EAGAE,uBAAuBA,CAACF,QAAoC;IAC1D,IAAI,CAACG,oBAAoB,GAAGH,QAAQ;EACtC;EAEA;;;;;EAKAI,YACEC,GAAW,EACMC,cAAA,GAAmCC,SAAS;IAA5C,KAAAD,cAAc,GAAdA,cAAc;IApBzB,KAAAE,SAAS,GAAqB,IAAI;IAClC,KAAAC,eAAe,GAAG,KAAK;IAqB7B,IAAI,CAACJ,GAAG,GAAGA,GAAG,CAACK,OAAO,CAAC,OAAO,EAAE,IAAI,CAAC;IACrC,IAAI,CAACC,UAAU,GAAGb,mBAAmB,CAACc,eAAe,EAAE;IACvDd,mBAAmB,CAACe,eAAe,CAACC,GAAG,CAAC,IAAI,CAACH,UAAU,CAAC;EAC1D;EAEA;;;;EAIO,MAAMI,OAAOA,CAAA;IAClB,IAAI,IAAI,CAACP,SAAS,EAAE;MAClB,MAAM,IAAIQ,KAAK,CAAC,8BAA8B,CAAC;IACjD;IACA,IAAI,IAAI,CAACP,eAAe,EAAE;MACxB,MAAM,IAAIO,KAAK,CAAC,+DAA+D,CAAC;IAClF;IACA,OAAO,IAAIC,OAAO,CAAO,CAACC,OAAO,EAAEC,MAAM,KAAI;;MAC3C,IAAIX,SAAoB;MACxB,IAAI;QACF,IAAI,CAACA,SAAS,GAAGA,SAAS,GAAG,IAAI,IAAI,CAACF,cAAc,CAAC,IAAI,CAACD,GAAG,CAAC;MAChE,CAAC,CAAC,OAAOe,GAAG,EAAE;QACZD,MAAM,CAACC,GAAG,CAAC;QACX;MACF;MACA,CAAAC,EAAA,OAAI,CAACpB,uBAAuB,cAAAoB,EAAA,uBAAAA,EAAA,CAAAC,IAAA,OAAGzB,eAAe,CAAC0B,UAAU,CAAC;MAC1Df,SAAS,CAACgB,OAAO,GAAIC,GAAG,IAAI;;QAC1B,IAAI,CAACC,cAAc,EAAE;QAErB;QACA,IAAIlB,SAAS,CAACmB,UAAU,KAAKpB,SAAS,CAACqB,IAAI,EAAE;UAC3CT,MAAM,CAAC,IAAIH,KAAK,CAAC,mBAAmBS,GAAG,CAACI,IAAI,KAAKJ,GAAG,CAACK,MAAM,EAAE,CAAC,CAAC;QACjE;QAEA,CAAAT,EAAA,OAAI,CAACpB,uBAAuB,cAAAoB,EAAA,uBAAAA,EAAA,CAAAC,IAAA,OAAGzB,eAAe,CAACkC,YAAY,CAAC;MAC9D,CAAC;MAEDvB,SAAS,CAACwB,MAAM,GAAIC,CAAC,IAAI;;QACvBf,OAAO,EAAE;QACT,CAAAG,EAAA,OAAI,CAACpB,uBAAuB,cAAAoB,EAAA,uBAAAA,EAAA,CAAAC,IAAA,OAAGzB,eAAe,CAACqC,SAAS,CAAC;QAEzD,IAAIpC,mBAAmB,CAACqC,WAAW,CAACC,MAAM,GAAG,CAAC,EAAE;UAC9C,MAAMC,OAAO,GAAG,CAAC,GAAGvC,mBAAmB,CAACqC,WAAW,CAAC;UACpDE,OAAO,CAACC,OAAO,CAAEC,IAAI,IAAK,IAAI,CAACC,QAAQ,CAACD,IAAI,CAAC,CAAC;UAC9CzC,mBAAmB,CAACqC,WAAW,GAAG,EAAE;QACtC;MACF,CAAC;MACD3B,SAAS,CAACiC,SAAS,GAAIhB,GAAG,IAAI;;QAC5B,IAAIA,GAAG,CAACc,IAAI,KAAK,GAAG,EAAE;UACpB,CAAAlB,EAAA,OAAI,CAAClB,oBAAoB,cAAAkB,EAAA,uBAAAA,EAAA,CAAAC,IAAA,OAAG;YAC1BoB,IAAI,EAAE;WACP,CAAC;QACJ,CAAC,MAAM;UACL,IAAI;YACF,MAAMC,OAAO,GAAGC,IAAI,CAACC,KAAK,CAACpB,GAAG,CAACc,IAAI,CAAkB;YACrD,CAAAO,EAAA,OAAI,CAAC3C,oBAAoB,cAAA2C,EAAA,uBAAAA,EAAA,CAAAxB,IAAA,OAAGqB,OAAO,CAAC;UACtC,CAAC,CAAC,OAAAI,EAAA,EAAM,CACR;QACF;MACF,CAAC;IACH,CAAC,CAAC;EACJ;EAEA;;;EAGOC,UAAUA,CAAA;;IACf,MAAM;MAAExC;IAAS,CAAE,GAAG,IAAI;IAC1B,IAAI,CAACA,SAAS,EAAE;MACd;IACF;IAEA;IACA,IAAI,CAACC,eAAe,GAAG,IAAI;IAC3B,IAAI,CAACiB,cAAc,EAAE;IAErB;IACA,CAAAL,EAAA,OAAI,CAACpB,uBAAuB,cAAAoB,EAAA,uBAAAA,EAAA,CAAAC,IAAA,OAAGzB,eAAe,CAACkC,YAAY,CAAC;IAC5D,IAAI,CAAC9B,uBAAuB,GAAGgD,SAAS;IACxC,IAAI,CAAC9C,oBAAoB,GAAG8C,SAAS;IAErC,IAAI;MACFzC,SAAS,CAAC0C,KAAK,EAAE;IACnB,CAAC,CAAC,OAAAJ,EAAA,EAAM;MACN;IAAA;EAEJ;EAEA;;;;EAION,QAAQA,CAACD,IAAY;IAC1B,MAAM;MAAE/B;IAAS,CAAE,GAAG,IAAI;IAC1B,IAAI,CAACA,SAAS,EAAE;MACdV,mBAAmB,CAACqC,WAAW,CAACgB,IAAI,CAACZ,IAAI,CAAC;MAC1C,IAAI,CAAC,IAAI,CAAC9B,eAAe,EAAE;QACzB,IAAI,CAACM,OAAO,EAAE;MAChB;MACA;IACF;IAEA;IACA,IAAIP,SAAS,CAACmB,UAAU,KAAKpB,SAAS,CAACqB,IAAI,EAAE;MAC3C9B,mBAAmB,CAACqC,WAAW,CAACgB,IAAI,CAACZ,IAAI,CAAC;MAC1C;IACF;IAEA/B,SAAS,CAAC4C,IAAI,CAACb,IAAI,CAAC;EACtB;EAEQb,cAAcA,CAAA;IACpB,MAAM;MAAElB;IAAS,CAAE,GAAG,IAAI;IAC1B,IAAI,CAACA,SAAS,EAAE;MACd;IACF;IACA,IAAI,CAACA,SAAS,GAAG,IAAI;IACrBA,SAAS,CAACgB,OAAO,GAAG,IAAI;IACxBhB,SAAS,CAAC6C,OAAO,GAAG,IAAI;IACxB7C,SAAS,CAACiC,SAAS,GAAG,IAAI;IAC1BjC,SAAS,CAACwB,MAAM,GAAG,IAAI;EACzB;EAEA;;;EAGOsB,OAAOA,CAAA;IACZxD,mBAAmB,CAACe,eAAe,CAAC0C,MAAM,CAAC,IAAI,CAAC5C,UAAU,CAAC;EAC7D;;AA5JA;AACeb,mBAAA,CAAAc,eAAe,GAAG,CAAC;AACnBd,mBAAA,CAAAe,eAAe,GAAG,IAAI2C,GAAG,EAAU;AACnC1D,mBAAA,CAAAqC,WAAW,GAAa,EAAE","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}
{"ast":null,"code":"import { standardErrors } from '../../../core/error/errors.js';\nimport { decodeFunctionData, getAddress, isAddress, pad } from 'viem';\nimport { getCode, readContract } from 'viem/actions';\nimport { abi, factoryAbi, factoryAddress } from './constants.js';\nexport async function findOwnerIndex({\n  address,\n  client,\n  publicKey,\n  factory,\n  factoryData\n}) {\n  const code = await getCode(client, {\n    address\n  });\n  // Check index of owner in the factoryData\n  // Note: importing an undeployed contract might need to be handled differently\n  // The implemention will likely require the signer to tell us the index\n  if (!code && factory && factoryData) {\n    if (getAddress(factory) !== getAddress(factoryAddress)) {\n      throw standardErrors.rpc.internal('unknown factory address');\n    }\n    const initData = decodeFunctionData({\n      abi: factoryAbi,\n      data: factoryData\n    });\n    if (initData.functionName !== 'createAccount') {\n      throw standardErrors.rpc.internal('unknown factory function');\n    }\n    const [owners] = initData.args;\n    return owners.findIndex(owner => {\n      return owner.toLowerCase() === formatPublicKey(publicKey).toLowerCase();\n    });\n  }\n  const ownerCount = await readContract(client, {\n    address,\n    abi,\n    functionName: 'ownerCount'\n  });\n  // Iterate from highest index down and return early when found\n  for (let i = Number(ownerCount) - 1; i >= 0; i--) {\n    const owner = await readContract(client, {\n      address,\n      abi,\n      functionName: 'ownerAtIndex',\n      args: [BigInt(i)]\n    });\n    const formatted = formatPublicKey(publicKey);\n    if (owner.toLowerCase() === formatted.toLowerCase()) {\n      return i;\n    }\n  }\n  return -1;\n}\n/**\n * Formats 20 byte addresses to 32 byte public keys. Contract uses 32 byte keys for owners.\n * @param publicKey - The public key to format\n * @returns The formatted public key\n */\nexport function formatPublicKey(publicKey) {\n  if (isAddress(publicKey)) {\n    return pad(publicKey);\n  }\n  return publicKey;\n}","map":{"version":3,"names":["standardErrors","decodeFunctionData","getAddress","isAddress","pad","getCode","readContract","abi","factoryAbi","factoryAddress","findOwnerIndex","address","client","publicKey","factory","factoryData","code","rpc","internal","initData","data","functionName","owners","args","findIndex","owner","toLowerCase","formatPublicKey","ownerCount","i","Number","BigInt","formatted"],"sources":["../../../../src/sign/scw/utils/findOwnerIndex.ts"],"sourcesContent":[null],"mappings":"AAAA,SAASA,cAAc,QAAQ,+BAAwB;AACvD,SAA+BC,kBAAkB,EAAEC,UAAU,EAAEC,SAAS,EAAEC,GAAG,QAAQ,MAAM;AAC3F,SAASC,OAAO,EAAEC,YAAY,QAAQ,cAAc;AACpD,SAASC,GAAG,EAAEC,UAAU,EAAEC,cAAc,QAAQ,gBAAgB;AAyBhE,OAAO,eAAeC,cAAcA,CAAC;EACnCC,OAAO;EACPC,MAAM;EACNC,SAAS;EACTC,OAAO;EACPC;AAAW,CACU;EACrB,MAAMC,IAAI,GAAG,MAAMX,OAAO,CAACO,MAAM,EAAE;IACjCD;GACD,CAAC;EAEF;EACA;EACA;EACA,IAAI,CAACK,IAAI,IAAIF,OAAO,IAAIC,WAAW,EAAE;IACnC,IAAIb,UAAU,CAACY,OAAO,CAAC,KAAKZ,UAAU,CAACO,cAAc,CAAC,EAAE;MACtD,MAAMT,cAAc,CAACiB,GAAG,CAACC,QAAQ,CAAC,yBAAyB,CAAC;IAC9D;IAEA,MAAMC,QAAQ,GAAGlB,kBAAkB,CAAC;MAClCM,GAAG,EAAEC,UAAU;MACfY,IAAI,EAAEL;KACP,CAAC;IAEF,IAAII,QAAQ,CAACE,YAAY,KAAK,eAAe,EAAE;MAC7C,MAAMrB,cAAc,CAACiB,GAAG,CAACC,QAAQ,CAAC,0BAA0B,CAAC;IAC/D;IAEA,MAAM,CAACI,MAAM,CAAC,GAAGH,QAAQ,CAACI,IAAI;IAC9B,OAAOD,MAAM,CAACE,SAAS,CAAEC,KAAoB,IAAI;MAC/C,OAAOA,KAAK,CAACC,WAAW,EAAE,KAAKC,eAAe,CAACd,SAAS,CAAC,CAACa,WAAW,EAAE;IACzE,CAAC,CAAC;EACJ;EAEA,MAAME,UAAU,GAAG,MAAMtB,YAAY,CAACM,MAAM,EAAE;IAC5CD,OAAO;IACPJ,GAAG;IACHc,YAAY,EAAE;GACf,CAAC;EAEF;EACA,KAAK,IAAIQ,CAAC,GAAGC,MAAM,CAACF,UAAU,CAAC,GAAG,CAAC,EAAEC,CAAC,IAAI,CAAC,EAAEA,CAAC,EAAE,EAAE;IAChD,MAAMJ,KAAK,GAAG,MAAMnB,YAAY,CAACM,MAAM,EAAE;MACvCD,OAAO;MACPJ,GAAG;MACHc,YAAY,EAAE,cAAc;MAC5BE,IAAI,EAAE,CAACQ,MAAM,CAACF,CAAC,CAAC;KACjB,CAAC;IAEF,MAAMG,SAAS,GAAGL,eAAe,CAACd,SAAS,CAAC;IAC5C,IAAIY,KAAK,CAACC,WAAW,EAAE,KAAKM,SAAS,CAACN,WAAW,EAAE,EAAE;MACnD,OAAOG,CAAC;IACV;EACF;EAEA,OAAO,CAAC,CAAC;AACX;AAEA;;;;;AAKA,OAAM,SAAUF,eAAeA,CAACd,SAAc;EAC5C,IAAIV,SAAS,CAACU,SAAS,CAAC,EAAE;IACxB,OAAOT,GAAG,CAACS,SAAS,CAAC;EACvB;EACA,OAAOA,SAAS;AAClB","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}
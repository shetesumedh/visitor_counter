{"ast":null,"code":"// Copyright (c) 2018-2023 Coinbase, Inc. <https://www.coinbase.com/>\nimport { standardErrors } from '../../../core/error/errors.js';\nimport { ScopedLocalStorage } from '../../../core/storage/ScopedLocalStorage.js';\nimport { bigIntStringFromBigInt, hexStringFromBuffer, randomBytesHex } from '../../../core/type/util.js';\nimport { WalletLinkConnection } from './connection/WalletLinkConnection.js';\nimport { LOCAL_STORAGE_ADDRESSES_KEY } from './constants.js';\nimport { RelayEventManager } from './RelayEventManager.js';\nimport { WalletLinkSession } from './type/WalletLinkSession.js';\nimport { isErrorResponse } from './type/Web3Response.js';\nimport { isMobileWeb } from './ui/components/util.js';\nimport { WalletLinkRelayUI } from './ui/WalletLinkRelayUI.js';\nimport { WLMobileRelayUI } from './ui/WLMobileRelayUI.js';\nexport class WalletLinkRelay {\n  constructor(options) {\n    this.chainCallbackParams = {\n      chainId: '',\n      jsonRpcUrl: ''\n    }; // to implement distinctUntilChanged\n    this.isMobileWeb = isMobileWeb();\n    this.linkedUpdated = linked => {\n      this.isLinked = linked;\n      const cachedAddresses = this.storage.getItem(LOCAL_STORAGE_ADDRESSES_KEY);\n      if (linked) {\n        // Only set linked session variable one way\n        this._session.linked = linked;\n      }\n      this.isUnlinkedErrorState = false;\n      if (cachedAddresses) {\n        const addresses = cachedAddresses.split(' ');\n        const wasConnectedViaStandalone = this.storage.getItem('IsStandaloneSigning') === 'true';\n        if (addresses[0] !== '' && !linked && this._session.linked && !wasConnectedViaStandalone) {\n          this.isUnlinkedErrorState = true;\n        }\n      }\n    };\n    this.metadataUpdated = (key, value) => {\n      this.storage.setItem(key, value);\n    };\n    this.chainUpdated = (chainId, jsonRpcUrl) => {\n      if (this.chainCallbackParams.chainId === chainId && this.chainCallbackParams.jsonRpcUrl === jsonRpcUrl) {\n        return;\n      }\n      this.chainCallbackParams = {\n        chainId,\n        jsonRpcUrl\n      };\n      if (this.chainCallback) {\n        this.chainCallback(jsonRpcUrl, Number.parseInt(chainId, 10));\n      }\n    };\n    this.accountUpdated = selectedAddress => {\n      if (this.accountsCallback) {\n        this.accountsCallback([selectedAddress]);\n      }\n      if (WalletLinkRelay.accountRequestCallbackIds.size > 0) {\n        // We get the ethereum address from the metadata.  If for whatever\n        // reason we don't get a response via an explicit web3 message\n        // we can still fulfill the eip1102 request.\n        Array.from(WalletLinkRelay.accountRequestCallbackIds.values()).forEach(id => {\n          this.invokeCallback(id, {\n            method: 'requestEthereumAccounts',\n            result: [selectedAddress]\n          });\n        });\n        WalletLinkRelay.accountRequestCallbackIds.clear();\n      }\n    };\n    this.resetAndReload = this.resetAndReload.bind(this);\n    this.linkAPIUrl = options.linkAPIUrl;\n    this.storage = options.storage;\n    this.metadata = options.metadata;\n    this.accountsCallback = options.accountsCallback;\n    this.chainCallback = options.chainCallback;\n    const {\n      session,\n      ui,\n      connection\n    } = this.subscribe();\n    this._session = session;\n    this.connection = connection;\n    this.relayEventManager = new RelayEventManager();\n    this.ui = ui;\n    this.ui.attach();\n  }\n  subscribe() {\n    const session = WalletLinkSession.load(this.storage) || WalletLinkSession.create(this.storage);\n    const {\n      linkAPIUrl\n    } = this;\n    const connection = new WalletLinkConnection({\n      session,\n      linkAPIUrl,\n      listener: this\n    });\n    const ui = this.isMobileWeb ? new WLMobileRelayUI() : new WalletLinkRelayUI();\n    connection.connect();\n    return {\n      session,\n      ui,\n      connection\n    };\n  }\n  resetAndReload() {\n    this.connection.destroy().then(() => {\n      /**\n       * Only clear storage if the session id we have in memory matches the one on disk\n       * Otherwise, in the case where we have 2 tabs, another tab might have cleared\n       * storage already.  In that case if we clear storage again, the user will be in\n       * a state where the first tab allows the user to connect but the session that\n       * was used isn't persisted.  This leaves the user in a state where they aren't\n       * connected to the mobile app.\n       */\n      const storedSession = WalletLinkSession.load(this.storage);\n      if ((storedSession === null || storedSession === void 0 ? void 0 : storedSession.id) === this._session.id) {\n        ScopedLocalStorage.clearAll();\n      }\n      document.location.reload();\n    }).catch(_ => {});\n  }\n  signEthereumTransaction(params) {\n    return this.sendRequest({\n      method: 'signEthereumTransaction',\n      params: {\n        fromAddress: params.fromAddress,\n        toAddress: params.toAddress,\n        weiValue: bigIntStringFromBigInt(params.weiValue),\n        data: hexStringFromBuffer(params.data, true),\n        nonce: params.nonce,\n        gasPriceInWei: params.gasPriceInWei ? bigIntStringFromBigInt(params.gasPriceInWei) : null,\n        maxFeePerGas: params.gasPriceInWei ? bigIntStringFromBigInt(params.gasPriceInWei) : null,\n        maxPriorityFeePerGas: params.gasPriceInWei ? bigIntStringFromBigInt(params.gasPriceInWei) : null,\n        gasLimit: params.gasLimit ? bigIntStringFromBigInt(params.gasLimit) : null,\n        chainId: params.chainId,\n        shouldSubmit: false\n      }\n    });\n  }\n  signAndSubmitEthereumTransaction(params) {\n    return this.sendRequest({\n      method: 'signEthereumTransaction',\n      params: {\n        fromAddress: params.fromAddress,\n        toAddress: params.toAddress,\n        weiValue: bigIntStringFromBigInt(params.weiValue),\n        data: hexStringFromBuffer(params.data, true),\n        nonce: params.nonce,\n        gasPriceInWei: params.gasPriceInWei ? bigIntStringFromBigInt(params.gasPriceInWei) : null,\n        maxFeePerGas: params.maxFeePerGas ? bigIntStringFromBigInt(params.maxFeePerGas) : null,\n        maxPriorityFeePerGas: params.maxPriorityFeePerGas ? bigIntStringFromBigInt(params.maxPriorityFeePerGas) : null,\n        gasLimit: params.gasLimit ? bigIntStringFromBigInt(params.gasLimit) : null,\n        chainId: params.chainId,\n        shouldSubmit: true\n      }\n    });\n  }\n  submitEthereumTransaction(signedTransaction, chainId) {\n    return this.sendRequest({\n      method: 'submitEthereumTransaction',\n      params: {\n        signedTransaction: hexStringFromBuffer(signedTransaction, true),\n        chainId\n      }\n    });\n  }\n  getWalletLinkSession() {\n    return this._session;\n  }\n  sendRequest(request) {\n    let hideSnackbarItem = null;\n    const id = randomBytesHex(8);\n    const cancel = error => {\n      this.publishWeb3RequestCanceledEvent(id);\n      this.handleErrorResponse(id, request.method, error);\n      hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n    };\n    return new Promise((resolve, reject) => {\n      {\n        hideSnackbarItem = this.ui.showConnecting({\n          isUnlinkedErrorState: this.isUnlinkedErrorState,\n          onCancel: cancel,\n          onResetConnection: this.resetAndReload\n        });\n      }\n      this.relayEventManager.callbacks.set(id, response => {\n        hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n        if (isErrorResponse(response)) {\n          return reject(new Error(response.errorMessage));\n        }\n        resolve(response);\n      });\n      this.publishWeb3RequestEvent(id, request);\n    });\n  }\n  publishWeb3RequestEvent(id, request) {\n    const message = {\n      type: 'WEB3_REQUEST',\n      id,\n      request\n    };\n    this.publishEvent('Web3Request', message, true).then(_ => {}).catch(err => {\n      this.handleWeb3ResponseMessage(message.id, {\n        method: request.method,\n        errorMessage: err.message\n      });\n    });\n    if (this.isMobileWeb) {\n      this.openCoinbaseWalletDeeplink(request.method);\n    }\n  }\n  // copied from MobileRelay\n  openCoinbaseWalletDeeplink(method) {\n    if (!(this.ui instanceof WLMobileRelayUI)) return;\n    // For mobile relay requests, open the Coinbase Wallet app\n    switch (method) {\n      case 'requestEthereumAccounts': // requestEthereumAccounts is handled via popup\n      case 'switchEthereumChain':\n        // switchEthereumChain doesn't need to open the app\n        return;\n      default:\n        window.addEventListener('blur', () => {\n          window.addEventListener('focus', () => {\n            this.connection.checkUnseenEvents();\n          }, {\n            once: true\n          });\n        }, {\n          once: true\n        });\n        this.ui.openCoinbaseWalletDeeplink();\n        break;\n    }\n  }\n  publishWeb3RequestCanceledEvent(id) {\n    const message = {\n      type: 'WEB3_REQUEST_CANCELED',\n      id\n    };\n    this.publishEvent('Web3RequestCanceled', message, false).then();\n  }\n  publishEvent(event, message, callWebhook) {\n    return this.connection.publishEvent(event, message, callWebhook);\n  }\n  handleWeb3ResponseMessage(id, response) {\n    if (response.method === 'requestEthereumAccounts') {\n      WalletLinkRelay.accountRequestCallbackIds.forEach(id => this.invokeCallback(id, response));\n      WalletLinkRelay.accountRequestCallbackIds.clear();\n      return;\n    }\n    this.invokeCallback(id, response);\n  }\n  handleErrorResponse(id, method, error) {\n    var _a;\n    const errorMessage = (_a = error === null || error === void 0 ? void 0 : error.message) !== null && _a !== void 0 ? _a : 'Unspecified error message.';\n    this.handleWeb3ResponseMessage(id, {\n      method,\n      errorMessage\n    });\n  }\n  invokeCallback(id, response) {\n    const callback = this.relayEventManager.callbacks.get(id);\n    if (callback) {\n      callback(response);\n      this.relayEventManager.callbacks.delete(id);\n    }\n  }\n  requestEthereumAccounts() {\n    const {\n      appName,\n      appLogoUrl\n    } = this.metadata;\n    const request = {\n      method: 'requestEthereumAccounts',\n      params: {\n        appName,\n        appLogoUrl\n      }\n    };\n    const hideSnackbarItem = null;\n    const id = randomBytesHex(8);\n    return new Promise((resolve, reject) => {\n      this.relayEventManager.callbacks.set(id, response => {\n        // @ts-ignore\n        hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n        if (isErrorResponse(response)) {\n          return reject(new Error(response.errorMessage));\n        }\n        resolve(response);\n      });\n      WalletLinkRelay.accountRequestCallbackIds.add(id);\n      this.publishWeb3RequestEvent(id, request);\n    });\n  }\n  watchAsset(type, address, symbol, decimals, image, chainId) {\n    const request = {\n      method: 'watchAsset',\n      params: {\n        type,\n        options: {\n          address,\n          symbol,\n          decimals,\n          image\n        },\n        chainId\n      }\n    };\n    let hideSnackbarItem = null;\n    const id = randomBytesHex(8);\n    const cancel = error => {\n      this.publishWeb3RequestCanceledEvent(id);\n      this.handleErrorResponse(id, request.method, error);\n      hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n    };\n    {\n      hideSnackbarItem = this.ui.showConnecting({\n        isUnlinkedErrorState: this.isUnlinkedErrorState,\n        onCancel: cancel,\n        onResetConnection: this.resetAndReload\n      });\n    }\n    return new Promise((resolve, reject) => {\n      this.relayEventManager.callbacks.set(id, response => {\n        hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n        if (isErrorResponse(response)) {\n          return reject(new Error(response.errorMessage));\n        }\n        resolve(response);\n      });\n      this.publishWeb3RequestEvent(id, request);\n    });\n  }\n  addEthereumChain(chainId, rpcUrls, iconUrls, blockExplorerUrls, chainName, nativeCurrency) {\n    const request = {\n      method: 'addEthereumChain',\n      params: {\n        chainId,\n        rpcUrls,\n        blockExplorerUrls,\n        chainName,\n        iconUrls,\n        nativeCurrency\n      }\n    };\n    let hideSnackbarItem = null;\n    const id = randomBytesHex(8);\n    const cancel = error => {\n      this.publishWeb3RequestCanceledEvent(id);\n      this.handleErrorResponse(id, request.method, error);\n      hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n    };\n    {\n      hideSnackbarItem = this.ui.showConnecting({\n        isUnlinkedErrorState: this.isUnlinkedErrorState,\n        onCancel: cancel,\n        onResetConnection: this.resetAndReload\n      });\n    }\n    return new Promise((resolve, reject) => {\n      this.relayEventManager.callbacks.set(id, response => {\n        hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n        if (isErrorResponse(response)) {\n          return reject(new Error(response.errorMessage));\n        }\n        resolve(response);\n      });\n      this.publishWeb3RequestEvent(id, request);\n    });\n  }\n  switchEthereumChain(chainId, address) {\n    const request = {\n      method: 'switchEthereumChain',\n      params: Object.assign({\n        chainId\n      }, {\n        address\n      })\n    };\n    let hideSnackbarItem = null;\n    const id = randomBytesHex(8);\n    const cancel = error => {\n      this.publishWeb3RequestCanceledEvent(id);\n      this.handleErrorResponse(id, request.method, error);\n      hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n    };\n    {\n      hideSnackbarItem = this.ui.showConnecting({\n        isUnlinkedErrorState: this.isUnlinkedErrorState,\n        onCancel: cancel,\n        onResetConnection: this.resetAndReload\n      });\n    }\n    return new Promise((resolve, reject) => {\n      this.relayEventManager.callbacks.set(id, response => {\n        hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n        if (isErrorResponse(response) && response.errorCode) {\n          return reject(standardErrors.provider.custom({\n            code: response.errorCode,\n            message: `Unrecognized chain ID. Try adding the chain using addEthereumChain first.`\n          }));\n        }\n        if (isErrorResponse(response)) {\n          return reject(new Error(response.errorMessage));\n        }\n        resolve(response);\n      });\n      this.publishWeb3RequestEvent(id, request);\n    });\n  }\n}\nWalletLinkRelay.accountRequestCallbackIds = new Set();","map":{"version":3,"names":["standardErrors","ScopedLocalStorage","bigIntStringFromBigInt","hexStringFromBuffer","randomBytesHex","WalletLinkConnection","LOCAL_STORAGE_ADDRESSES_KEY","RelayEventManager","WalletLinkSession","isErrorResponse","isMobileWeb","WalletLinkRelayUI","WLMobileRelayUI","WalletLinkRelay","constructor","options","chainCallbackParams","chainId","jsonRpcUrl","linkedUpdated","linked","isLinked","cachedAddresses","storage","getItem","_session","isUnlinkedErrorState","addresses","split","wasConnectedViaStandalone","metadataUpdated","key","value","setItem","chainUpdated","chainCallback","Number","parseInt","accountUpdated","selectedAddress","accountsCallback","accountRequestCallbackIds","size","Array","from","values","forEach","id","invokeCallback","method","result","clear","resetAndReload","bind","linkAPIUrl","metadata","session","ui","connection","subscribe","relayEventManager","attach","load","create","listener","connect","destroy","then","storedSession","clearAll","document","location","reload","catch","_","signEthereumTransaction","params","sendRequest","fromAddress","toAddress","weiValue","data","nonce","gasPriceInWei","maxFeePerGas","maxPriorityFeePerGas","gasLimit","shouldSubmit","signAndSubmitEthereumTransaction","submitEthereumTransaction","signedTransaction","getWalletLinkSession","request","hideSnackbarItem","cancel","error","publishWeb3RequestCanceledEvent","handleErrorResponse","Promise","resolve","reject","showConnecting","onCancel","onResetConnection","callbacks","set","response","Error","errorMessage","publishWeb3RequestEvent","message","type","publishEvent","err","handleWeb3ResponseMessage","openCoinbaseWalletDeeplink","window","addEventListener","checkUnseenEvents","once","event","callWebhook","_a","callback","get","delete","requestEthereumAccounts","appName","appLogoUrl","add","watchAsset","address","symbol","decimals","image","addEthereumChain","rpcUrls","iconUrls","blockExplorerUrls","chainName","nativeCurrency","switchEthereumChain","Object","assign","errorCode","provider","custom","code","Set"],"sources":["../../../../src/sign/walletlink/relay/WalletLinkRelay.ts"],"sourcesContent":[null],"mappings":"AAAA;AAEA,SAASA,cAAc,QAAQ,+BAAwB;AAEvD,SAASC,kBAAkB,QAAQ,6CAAsC;AAEzE,SAASC,sBAAsB,EAAEC,mBAAmB,EAAEC,cAAc,QAAQ,4BAAqB;AACjG,SACEC,oBAAoB,QAEf,sCAAsC;AAC7C,SAASC,2BAA2B,QAAQ,gBAAgB;AAC5D,SAASC,iBAAiB,QAAQ,wBAAwB;AAG1D,SAASC,iBAAiB,QAAQ,6BAA6B;AAE/D,SAASC,eAAe,QAAsB,wBAAwB;AACtE,SAASC,WAAW,QAAQ,yBAAyB;AAErD,SAASC,iBAAiB,QAAQ,2BAA2B;AAC7D,SAASC,eAAe,QAAQ,yBAAyB;AAUzD,OAAM,MAAOC,eAAe;EAmB1BC,YAAYC,OAAyC;IAV7C,KAAAC,mBAAmB,GAAG;MAAEC,OAAO,EAAE,EAAE;MAAEC,UAAU,EAAE;IAAE,CAAE,CAAC,CAAC;IAIvD,KAAAR,WAAW,GAAGA,WAAW,EAAE;IA2CnC,KAAAS,aAAa,GAAIC,MAAe,IAAI;MAClC,IAAI,CAACC,QAAQ,GAAGD,MAAM;MACtB,MAAME,eAAe,GAAG,IAAI,CAACC,OAAO,CAACC,OAAO,CAAClB,2BAA2B,CAAC;MAEzE,IAAIc,MAAM,EAAE;QACV;QACA,IAAI,CAACK,QAAQ,CAACL,MAAM,GAAGA,MAAM;MAC/B;MAEA,IAAI,CAACM,oBAAoB,GAAG,KAAK;MAEjC,IAAIJ,eAAe,EAAE;QACnB,MAAMK,SAAS,GAAGL,eAAe,CAACM,KAAK,CAAC,GAAG,CAAa;QACxD,MAAMC,yBAAyB,GAAG,IAAI,CAACN,OAAO,CAACC,OAAO,CAAC,qBAAqB,CAAC,KAAK,MAAM;QACxF,IAAIG,SAAS,CAAC,CAAC,CAAC,KAAK,EAAE,IAAI,CAACP,MAAM,IAAI,IAAI,CAACK,QAAQ,CAACL,MAAM,IAAI,CAACS,yBAAyB,EAAE;UACxF,IAAI,CAACH,oBAAoB,GAAG,IAAI;QAClC;MACF;IACF,CAAC;IAED,KAAAI,eAAe,GAAG,CAACC,GAAW,EAAEC,KAAa,KAAI;MAC/C,IAAI,CAACT,OAAO,CAACU,OAAO,CAACF,GAAG,EAAEC,KAAK,CAAC;IAClC,CAAC;IAED,KAAAE,YAAY,GAAG,CAACjB,OAAe,EAAEC,UAAkB,KAAI;MACrD,IACE,IAAI,CAACF,mBAAmB,CAACC,OAAO,KAAKA,OAAO,IAC5C,IAAI,CAACD,mBAAmB,CAACE,UAAU,KAAKA,UAAU,EAClD;QACA;MACF;MACA,IAAI,CAACF,mBAAmB,GAAG;QACzBC,OAAO;QACPC;OACD;MAED,IAAI,IAAI,CAACiB,aAAa,EAAE;QACtB,IAAI,CAACA,aAAa,CAACjB,UAAU,EAAEkB,MAAM,CAACC,QAAQ,CAACpB,OAAO,EAAE,EAAE,CAAC,CAAC;MAC9D;IACF,CAAC;IAED,KAAAqB,cAAc,GAAIC,eAAuB,IAAI;MAC3C,IAAI,IAAI,CAACC,gBAAgB,EAAE;QACzB,IAAI,CAACA,gBAAgB,CAAC,CAACD,eAAe,CAAC,CAAC;MAC1C;MACA,IAAI1B,eAAe,CAAC4B,yBAAyB,CAACC,IAAI,GAAG,CAAC,EAAE;QACtD;QACA;QACA;QACAC,KAAK,CAACC,IAAI,CAAC/B,eAAe,CAAC4B,yBAAyB,CAACI,MAAM,EAAE,CAAC,CAACC,OAAO,CAAEC,EAAE,IAAI;UAC5E,IAAI,CAACC,cAAc,CAACD,EAAE,EAAE;YACtBE,MAAM,EAAE,yBAAyB;YACjCC,MAAM,EAAE,CAACX,eAA0B;WACpC,CAAC;QACJ,CAAC,CAAC;QACF1B,eAAe,CAAC4B,yBAAyB,CAACU,KAAK,EAAE;MACnD;IACF,CAAC;IA7FC,IAAI,CAACC,cAAc,GAAG,IAAI,CAACA,cAAc,CAACC,IAAI,CAAC,IAAI,CAAC;IAEpD,IAAI,CAACC,UAAU,GAAGvC,OAAO,CAACuC,UAAU;IACpC,IAAI,CAAC/B,OAAO,GAAGR,OAAO,CAACQ,OAAO;IAC9B,IAAI,CAACgC,QAAQ,GAAGxC,OAAO,CAACwC,QAAQ;IAChC,IAAI,CAACf,gBAAgB,GAAGzB,OAAO,CAACyB,gBAAgB;IAChD,IAAI,CAACL,aAAa,GAAGpB,OAAO,CAACoB,aAAa;IAE1C,MAAM;MAAEqB,OAAO;MAAEC,EAAE;MAAEC;IAAU,CAAE,GAAG,IAAI,CAACC,SAAS,EAAE;IAEpD,IAAI,CAAClC,QAAQ,GAAG+B,OAAO;IACvB,IAAI,CAACE,UAAU,GAAGA,UAAU;IAE5B,IAAI,CAACE,iBAAiB,GAAG,IAAIrD,iBAAiB,EAAE;IAEhD,IAAI,CAACkD,EAAE,GAAGA,EAAE;IACZ,IAAI,CAACA,EAAE,CAACI,MAAM,EAAE;EAClB;EAEQF,SAASA,CAAA;IACf,MAAMH,OAAO,GAAGhD,iBAAiB,CAACsD,IAAI,CAAC,IAAI,CAACvC,OAAO,CAAC,IAAIf,iBAAiB,CAACuD,MAAM,CAAC,IAAI,CAACxC,OAAO,CAAC;IAE9F,MAAM;MAAE+B;IAAU,CAAE,GAAG,IAAI;IAC3B,MAAMI,UAAU,GAAG,IAAIrD,oBAAoB,CAAC;MAC1CmD,OAAO;MACPF,UAAU;MACVU,QAAQ,EAAE;KACX,CAAC;IAEF,MAAMP,EAAE,GAAG,IAAI,CAAC/C,WAAW,GAAG,IAAIE,eAAe,EAAE,GAAG,IAAID,iBAAiB,EAAE;IAE7E+C,UAAU,CAACO,OAAO,EAAE;IAEpB,OAAO;MAAET,OAAO;MAAEC,EAAE;MAAEC;IAAU,CAAE;EACpC;EA6DON,cAAcA,CAAA;IACnB,IAAI,CAACM,UAAU,CACZQ,OAAO,EAAE,CACTC,IAAI,CAAC,MAAK;MACT;;;;;;;;MAQA,MAAMC,aAAa,GAAG5D,iBAAiB,CAACsD,IAAI,CAAC,IAAI,CAACvC,OAAO,CAAC;MAC1D,IAAI,CAAA6C,aAAa,aAAbA,aAAa,uBAAbA,aAAa,CAAErB,EAAE,MAAK,IAAI,CAACtB,QAAQ,CAACsB,EAAE,EAAE;QAC1C9C,kBAAkB,CAACoE,QAAQ,EAAE;MAC/B;MAEAC,QAAQ,CAACC,QAAQ,CAACC,MAAM,EAAE;IAC5B,CAAC,CAAC,CACDC,KAAK,CAAEC,CAAC,IAAI,CAAE,CAAC,CAAC;EACrB;EAEOC,uBAAuBA,CAACC,MAAiC;IAC9D,OAAO,IAAI,CAACC,WAAW,CAAC;MACtB5B,MAAM,EAAE,yBAAyB;MACjC2B,MAAM,EAAE;QACNE,WAAW,EAAEF,MAAM,CAACE,WAAW;QAC/BC,SAAS,EAAEH,MAAM,CAACG,SAAS;QAC3BC,QAAQ,EAAE9E,sBAAsB,CAAC0E,MAAM,CAACI,QAAQ,CAAC;QACjDC,IAAI,EAAE9E,mBAAmB,CAACyE,MAAM,CAACK,IAAI,EAAE,IAAI,CAAC;QAC5CC,KAAK,EAAEN,MAAM,CAACM,KAAK;QACnBC,aAAa,EAAEP,MAAM,CAACO,aAAa,GAAGjF,sBAAsB,CAAC0E,MAAM,CAACO,aAAa,CAAC,GAAG,IAAI;QACzFC,YAAY,EAAER,MAAM,CAACO,aAAa,GAAGjF,sBAAsB,CAAC0E,MAAM,CAACO,aAAa,CAAC,GAAG,IAAI;QACxFE,oBAAoB,EAAET,MAAM,CAACO,aAAa,GACtCjF,sBAAsB,CAAC0E,MAAM,CAACO,aAAa,CAAC,GAC5C,IAAI;QACRG,QAAQ,EAAEV,MAAM,CAACU,QAAQ,GAAGpF,sBAAsB,CAAC0E,MAAM,CAACU,QAAQ,CAAC,GAAG,IAAI;QAC1ErE,OAAO,EAAE2D,MAAM,CAAC3D,OAAO;QACvBsE,YAAY,EAAE;;KAEjB,CAAC;EACJ;EAEOC,gCAAgCA,CAACZ,MAAiC;IACvE,OAAO,IAAI,CAACC,WAAW,CAAyD;MAC9E5B,MAAM,EAAE,yBAAyB;MACjC2B,MAAM,EAAE;QACNE,WAAW,EAAEF,MAAM,CAACE,WAAW;QAC/BC,SAAS,EAAEH,MAAM,CAACG,SAAS;QAC3BC,QAAQ,EAAE9E,sBAAsB,CAAC0E,MAAM,CAACI,QAAQ,CAAC;QACjDC,IAAI,EAAE9E,mBAAmB,CAACyE,MAAM,CAACK,IAAI,EAAE,IAAI,CAAC;QAC5CC,KAAK,EAAEN,MAAM,CAACM,KAAK;QACnBC,aAAa,EAAEP,MAAM,CAACO,aAAa,GAAGjF,sBAAsB,CAAC0E,MAAM,CAACO,aAAa,CAAC,GAAG,IAAI;QACzFC,YAAY,EAAER,MAAM,CAACQ,YAAY,GAAGlF,sBAAsB,CAAC0E,MAAM,CAACQ,YAAY,CAAC,GAAG,IAAI;QACtFC,oBAAoB,EAAET,MAAM,CAACS,oBAAoB,GAC7CnF,sBAAsB,CAAC0E,MAAM,CAACS,oBAAoB,CAAC,GACnD,IAAI;QACRC,QAAQ,EAAEV,MAAM,CAACU,QAAQ,GAAGpF,sBAAsB,CAAC0E,MAAM,CAACU,QAAQ,CAAC,GAAG,IAAI;QAC1ErE,OAAO,EAAE2D,MAAM,CAAC3D,OAAO;QACvBsE,YAAY,EAAE;;KAEjB,CAAC;EACJ;EAEOE,yBAAyBA,CAACC,iBAAyB,EAAEzE,OAAe;IACzE,OAAO,IAAI,CAAC4D,WAAW,CAAC;MACtB5B,MAAM,EAAE,2BAA2B;MACnC2B,MAAM,EAAE;QACNc,iBAAiB,EAAEvF,mBAAmB,CAACuF,iBAAiB,EAAE,IAAI,CAAC;QAC/DzE;;KAEH,CAAC;EACJ;EAEO0E,oBAAoBA,CAAA;IACzB,OAAO,IAAI,CAAClE,QAAQ;EACtB;EAEOoD,WAAWA,CAIhBe,OAAmC;IACnC,IAAIC,gBAAgB,GAAwB,IAAI;IAChD,MAAM9C,EAAE,GAAG3C,cAAc,CAAC,CAAC,CAAC;IAE5B,MAAM0F,MAAM,GAAIC,KAAa,IAAI;MAC/B,IAAI,CAACC,+BAA+B,CAACjD,EAAE,CAAC;MACxC,IAAI,CAACkD,mBAAmB,CAAClD,EAAE,EAAE6C,OAAO,CAAC3C,MAAM,EAAE8C,KAAK,CAAC;MACnDF,gBAAgB,aAAhBA,gBAAgB,uBAAhBA,gBAAgB,EAAI;IACtB,CAAC;IAED,OAAO,IAAIK,OAAO,CAAW,CAACC,OAAO,EAAEC,MAAM,KAAI;MAC/C;QACEP,gBAAgB,GAAG,IAAI,CAACpC,EAAE,CAAC4C,cAAc,CAAC;UACxC3E,oBAAoB,EAAE,IAAI,CAACA,oBAAoB;UAC/C4E,QAAQ,EAAER,MAAM;UAChBS,iBAAiB,EAAE,IAAI,CAACnD;SACzB,CAAC;MACJ;MAEA,IAAI,CAACQ,iBAAiB,CAAC4C,SAAS,CAACC,GAAG,CAAC1D,EAAE,EAAG2D,QAAQ,IAAI;QACpDb,gBAAgB,aAAhBA,gBAAgB,uBAAhBA,gBAAgB,EAAI;QACpB,IAAIpF,eAAe,CAACiG,QAAQ,CAAC,EAAE;UAC7B,OAAON,MAAM,CAAC,IAAIO,KAAK,CAACD,QAAQ,CAACE,YAAY,CAAC,CAAC;QACjD;QAEAT,OAAO,CAACO,QAAoB,CAAC;MAC/B,CAAC,CAAC;MAEF,IAAI,CAACG,uBAAuB,CAAC9D,EAAE,EAAE6C,OAAO,CAAC;IAC3C,CAAC,CAAC;EACJ;EAEQiB,uBAAuBA,CAAC9D,EAAU,EAAE6C,OAAoB;IAC9D,MAAMkB,OAAO,GAAwB;MAAEC,IAAI,EAAE,cAAc;MAAEhE,EAAE;MAAE6C;IAAO,CAAE;IAC1E,IAAI,CAACoB,YAAY,CAAC,aAAa,EAAEF,OAAO,EAAE,IAAI,CAAC,CAC5C3C,IAAI,CAAEO,CAAC,IAAI,CAAE,CAAC,CAAC,CACfD,KAAK,CAAEwC,GAAG,IAAI;MACb,IAAI,CAACC,yBAAyB,CAACJ,OAAO,CAAC/D,EAAE,EAAE;QACzCE,MAAM,EAAE2C,OAAO,CAAC3C,MAAM;QACtB2D,YAAY,EAAEK,GAAG,CAACH;OACnB,CAAC;IACJ,CAAC,CAAC;IAEJ,IAAI,IAAI,CAACpG,WAAW,EAAE;MACpB,IAAI,CAACyG,0BAA0B,CAACvB,OAAO,CAAC3C,MAAM,CAAC;IACjD;EACF;EAEA;EACQkE,0BAA0BA,CAAClE,MAAkB;IACnD,IAAI,EAAE,IAAI,CAACQ,EAAE,YAAY7C,eAAe,CAAC,EAAE;IAE3C;IACA,QAAQqC,MAAM;MACZ,KAAK,yBAAyB,CAAC,CAAC;MAChC,KAAK,qBAAqB;QAAE;QAC1B;MACF;QACEmE,MAAM,CAACC,gBAAgB,CACrB,MAAM,EACN,MAAK;UACHD,MAAM,CAACC,gBAAgB,CACrB,OAAO,EACP,MAAK;YACH,IAAI,CAAC3D,UAAU,CAAC4D,iBAAiB,EAAE;UACrC,CAAC,EACD;YAAEC,IAAI,EAAE;UAAI,CAAE,CACf;QACH,CAAC,EACD;UAAEA,IAAI,EAAE;QAAI,CAAE,CACf;QACD,IAAI,CAAC9D,EAAE,CAAC0D,0BAA0B,EAAE;QACpC;IACJ;EACF;EAEQnB,+BAA+BA,CAACjD,EAAU;IAChD,MAAM+D,OAAO,GAAwB;MACnCC,IAAI,EAAE,uBAAuB;MAC7BhE;KACD;IACD,IAAI,CAACiE,YAAY,CAAC,qBAAqB,EAAEF,OAAO,EAAE,KAAK,CAAC,CAAC3C,IAAI,EAAE;EACjE;EAEQ6C,YAAYA,CAClBQ,KAAa,EACbV,OAA4B,EAC5BW,WAAoB;IAEpB,OAAO,IAAI,CAAC/D,UAAU,CAACsD,YAAY,CAACQ,KAAK,EAAEV,OAAO,EAAEW,WAAW,CAAC;EAClE;EAEAP,yBAAyBA,CAACnE,EAAU,EAAE2D,QAAsB;IAC1D,IAAIA,QAAQ,CAACzD,MAAM,KAAK,yBAAyB,EAAE;MACjDpC,eAAe,CAAC4B,yBAAyB,CAACK,OAAO,CAAEC,EAAE,IAAK,IAAI,CAACC,cAAc,CAACD,EAAE,EAAE2D,QAAQ,CAAC,CAAC;MAC5F7F,eAAe,CAAC4B,yBAAyB,CAACU,KAAK,EAAE;MACjD;IACF;IAEA,IAAI,CAACH,cAAc,CAACD,EAAE,EAAE2D,QAAQ,CAAC;EACnC;EAEQT,mBAAmBA,CAAClD,EAAU,EAAEE,MAAkB,EAAE8C,KAAa;;IACvE,MAAMa,YAAY,GAAG,CAAAc,EAAA,GAAA3B,KAAK,aAALA,KAAK,uBAALA,KAAK,CAAEe,OAAO,cAAAY,EAAA,cAAAA,EAAA,GAAI,4BAA4B;IACnE,IAAI,CAACR,yBAAyB,CAACnE,EAAE,EAAE;MACjCE,MAAM;MACN2D;KACD,CAAC;EACJ;EAEQ5D,cAAcA,CAACD,EAAU,EAAE2D,QAAsB;IACvD,MAAMiB,QAAQ,GAAG,IAAI,CAAC/D,iBAAiB,CAAC4C,SAAS,CAACoB,GAAG,CAAC7E,EAAE,CAAC;IACzD,IAAI4E,QAAQ,EAAE;MACZA,QAAQ,CAACjB,QAAQ,CAAC;MAClB,IAAI,CAAC9C,iBAAiB,CAAC4C,SAAS,CAACqB,MAAM,CAAC9E,EAAE,CAAC;IAC7C;EACF;EAEO+E,uBAAuBA,CAAA;IAC5B,MAAM;MAAEC,OAAO;MAAEC;IAAU,CAAE,GAAG,IAAI,CAACzE,QAAQ;IAC7C,MAAMqC,OAAO,GAAgB;MAC3B3C,MAAM,EAAE,yBAAyB;MACjC2B,MAAM,EAAE;QACNmD,OAAO;QACPC;;KAEH;IAED,MAAMnC,gBAAgB,GAAwB,IAAI;IAClD,MAAM9C,EAAE,GAAG3C,cAAc,CAAC,CAAC,CAAC;IAE5B,OAAO,IAAI8F,OAAO,CAA0C,CAACC,OAAO,EAAEC,MAAM,KAAI;MAC9E,IAAI,CAACxC,iBAAiB,CAAC4C,SAAS,CAACC,GAAG,CAAC1D,EAAE,EAAG2D,QAAQ,IAAI;QACpD;QACAb,gBAAgB,aAAhBA,gBAAgB,uBAAhBA,gBAAgB,EAAI;QACpB,IAAIpF,eAAe,CAACiG,QAAQ,CAAC,EAAE;UAC7B,OAAON,MAAM,CAAC,IAAIO,KAAK,CAACD,QAAQ,CAACE,YAAY,CAAC,CAAC;QACjD;QACAT,OAAO,CAACO,QAAmD,CAAC;MAC9D,CAAC,CAAC;MACF7F,eAAe,CAAC4B,yBAAyB,CAACwF,GAAG,CAAClF,EAAE,CAAC;MACjD,IAAI,CAAC8D,uBAAuB,CAAC9D,EAAE,EAAE6C,OAAO,CAAC;IAC3C,CAAC,CAAC;EACJ;EAEAsC,UAAUA,CACRnB,IAAY,EACZoB,OAAe,EACfC,MAAe,EACfC,QAAiB,EACjBC,KAAc,EACdrH,OAAgB;IAEhB,MAAM2E,OAAO,GAAgB;MAC3B3C,MAAM,EAAE,YAAY;MACpB2B,MAAM,EAAE;QACNmC,IAAI;QACJhG,OAAO,EAAE;UACPoH,OAAO;UACPC,MAAM;UACNC,QAAQ;UACRC;SACD;QACDrH;;KAEH;IAED,IAAI4E,gBAAgB,GAAwB,IAAI;IAChD,MAAM9C,EAAE,GAAG3C,cAAc,CAAC,CAAC,CAAC;IAE5B,MAAM0F,MAAM,GAAIC,KAAa,IAAI;MAC/B,IAAI,CAACC,+BAA+B,CAACjD,EAAE,CAAC;MACxC,IAAI,CAACkD,mBAAmB,CAAClD,EAAE,EAAE6C,OAAO,CAAC3C,MAAM,EAAE8C,KAAK,CAAC;MACnDF,gBAAgB,aAAhBA,gBAAgB,uBAAhBA,gBAAgB,EAAI;IACtB,CAAC;IAED;MACEA,gBAAgB,GAAG,IAAI,CAACpC,EAAE,CAAC4C,cAAc,CAAC;QACxC3E,oBAAoB,EAAE,IAAI,CAACA,oBAAoB;QAC/C4E,QAAQ,EAAER,MAAM;QAChBS,iBAAiB,EAAE,IAAI,CAACnD;OACzB,CAAC;IACJ;IAEA,OAAO,IAAI8C,OAAO,CAA6B,CAACC,OAAO,EAAEC,MAAM,KAAI;MACjE,IAAI,CAACxC,iBAAiB,CAAC4C,SAAS,CAACC,GAAG,CAAC1D,EAAE,EAAG2D,QAAQ,IAAI;QACpDb,gBAAgB,aAAhBA,gBAAgB,uBAAhBA,gBAAgB,EAAI;QAEpB,IAAIpF,eAAe,CAACiG,QAAQ,CAAC,EAAE;UAC7B,OAAON,MAAM,CAAC,IAAIO,KAAK,CAACD,QAAQ,CAACE,YAAY,CAAC,CAAC;QACjD;QACAT,OAAO,CAACO,QAAsC,CAAC;MACjD,CAAC,CAAC;MAEF,IAAI,CAACG,uBAAuB,CAAC9D,EAAE,EAAE6C,OAAO,CAAC;IAC3C,CAAC,CAAC;EACJ;EAEA2C,gBAAgBA,CACdtH,OAAe,EACfuH,OAAiB,EACjBC,QAAkB,EAClBC,iBAA2B,EAC3BC,SAAkB,EAClBC,cAIC;IAED,MAAMhD,OAAO,GAAgB;MAC3B3C,MAAM,EAAE,kBAAkB;MAC1B2B,MAAM,EAAE;QACN3D,OAAO;QACPuH,OAAO;QACPE,iBAAiB;QACjBC,SAAS;QACTF,QAAQ;QACRG;;KAEH;IAED,IAAI/C,gBAAgB,GAAwB,IAAI;IAChD,MAAM9C,EAAE,GAAG3C,cAAc,CAAC,CAAC,CAAC;IAE5B,MAAM0F,MAAM,GAAIC,KAAa,IAAI;MAC/B,IAAI,CAACC,+BAA+B,CAACjD,EAAE,CAAC;MACxC,IAAI,CAACkD,mBAAmB,CAAClD,EAAE,EAAE6C,OAAO,CAAC3C,MAAM,EAAE8C,KAAK,CAAC;MACnDF,gBAAgB,aAAhBA,gBAAgB,uBAAhBA,gBAAgB,EAAI;IACtB,CAAC;IAED;MACEA,gBAAgB,GAAG,IAAI,CAACpC,EAAE,CAAC4C,cAAc,CAAC;QACxC3E,oBAAoB,EAAE,IAAI,CAACA,oBAAoB;QAC/C4E,QAAQ,EAAER,MAAM;QAChBS,iBAAiB,EAAE,IAAI,CAACnD;OACzB,CAAC;IACJ;IAEA,OAAO,IAAI8C,OAAO,CAAmC,CAACC,OAAO,EAAEC,MAAM,KAAI;MACvE,IAAI,CAACxC,iBAAiB,CAAC4C,SAAS,CAACC,GAAG,CAAC1D,EAAE,EAAG2D,QAAQ,IAAI;QACpDb,gBAAgB,aAAhBA,gBAAgB,uBAAhBA,gBAAgB,EAAI;QAEpB,IAAIpF,eAAe,CAACiG,QAAQ,CAAC,EAAE;UAC7B,OAAON,MAAM,CAAC,IAAIO,KAAK,CAACD,QAAQ,CAACE,YAAY,CAAC,CAAC;QACjD;QACAT,OAAO,CAACO,QAA4C,CAAC;MACvD,CAAC,CAAC;MAEF,IAAI,CAACG,uBAAuB,CAAC9D,EAAE,EAAE6C,OAAO,CAAC;IAC3C,CAAC,CAAC;EACJ;EAEAiD,mBAAmBA,CACjB5H,OAAe,EACfkH,OAAgB;IAEhB,MAAMvC,OAAO,GAAgB;MAC3B3C,MAAM,EAAE,qBAAqB;MAC7B2B,MAAM,EAAAkE,MAAA,CAAAC,MAAA;QACJ9H;MAAO,GACJ;QAAEkH;MAAO,CAAE;KAEjB;IAED,IAAItC,gBAAgB,GAAwB,IAAI;IAChD,MAAM9C,EAAE,GAAG3C,cAAc,CAAC,CAAC,CAAC;IAE5B,MAAM0F,MAAM,GAAIC,KAAa,IAAI;MAC/B,IAAI,CAACC,+BAA+B,CAACjD,EAAE,CAAC;MACxC,IAAI,CAACkD,mBAAmB,CAAClD,EAAE,EAAE6C,OAAO,CAAC3C,MAAM,EAAE8C,KAAK,CAAC;MACnDF,gBAAgB,aAAhBA,gBAAgB,uBAAhBA,gBAAgB,EAAI;IACtB,CAAC;IAED;MACEA,gBAAgB,GAAG,IAAI,CAACpC,EAAE,CAAC4C,cAAc,CAAC;QACxC3E,oBAAoB,EAAE,IAAI,CAACA,oBAAoB;QAC/C4E,QAAQ,EAAER,MAAM;QAChBS,iBAAiB,EAAE,IAAI,CAACnD;OACzB,CAAC;IACJ;IAEA,OAAO,IAAI8C,OAAO,CAAsC,CAACC,OAAO,EAAEC,MAAM,KAAI;MAC1E,IAAI,CAACxC,iBAAiB,CAAC4C,SAAS,CAACC,GAAG,CAAC1D,EAAE,EAAG2D,QAAQ,IAAI;QACpDb,gBAAgB,aAAhBA,gBAAgB,uBAAhBA,gBAAgB,EAAI;QACpB,IAAIpF,eAAe,CAACiG,QAAQ,CAAC,IAAIA,QAAQ,CAACsC,SAAS,EAAE;UACnD,OAAO5C,MAAM,CACXpG,cAAc,CAACiJ,QAAQ,CAACC,MAAM,CAAC;YAC7BC,IAAI,EAAEzC,QAAQ,CAACsC,SAAS;YACxBlC,OAAO,EAAE;WACV,CAAC,CACH;QACH;QACA,IAAIrG,eAAe,CAACiG,QAAQ,CAAC,EAAE;UAC7B,OAAON,MAAM,CAAC,IAAIO,KAAK,CAACD,QAAQ,CAACE,YAAY,CAAC,CAAC;QACjD;QAEAT,OAAO,CAACO,QAA+C,CAAC;MAC1D,CAAC,CAAC;MAEF,IAAI,CAACG,uBAAuB,CAAC9D,EAAE,EAAE6C,OAAO,CAAC;IAC3C,CAAC,CAAC;EACJ;;AAlfe/E,eAAA,CAAA4B,yBAAyB,GAAG,IAAI2G,GAAG,EAAU","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}